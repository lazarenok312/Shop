{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Витрина Ритейл</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}"/>
    <link type="text/css" rel="stylesheet" href="{% static 'css/slick.css' %}"/>
    <link type="text/css" rel="stylesheet" href="{% static 'css/slick-theme.css' %}"/>
    <link type="text/css" rel="stylesheet" href="{% static 'css/nouislider.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">
    <link type="text/css" rel="stylesheet" href="{% static 'css/style.css' %}"/>
    {#    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@14.7.0/distribute/nouislider.min.css">#}
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nouislider@14.7.0/distribute/nouislider.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<div id="notification" class="notification"></div>
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const alerts = document.querySelectorAll('.messages .alert');
            alerts.forEach(alert => {
                // Показываем плавно
                alert.style.opacity = 1;
                alert.style.transition = 'opacity 0.5s';

                setTimeout(() => {
                    alert.style.opacity = 0;
                    setTimeout(() => alert.remove(), 500); // окончательно убираем из DOM
                }, 5000);
            });
        });
    </script>
{% endif %}

<script>
    function showNotification(message, type = "success") {
        const notif = document.getElementById("notification");
        notif.textContent = message;
        notif.style.background = type === "error" ? "#dc3545" : "#28a745";
        notif.style.display = "block";
        notif.style.opacity = "1";

        setTimeout(() => {
            notif.style.opacity = "0";
            setTimeout(() => notif.style.display = "none", 300);
        }, 2000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                const c = cookie.trim();
                if (c.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(c.split('=')[1]);
                }
            });
        }
        return cookieValue;
    }

    function closeProductModal() {
        const modal = document.getElementById('product-modal');
        modal.style.display = "none";
    }

    // Закрытие кликом вне модалки
    window.onclick = function (event) {
        const modal = document.getElementById('product-modal');
        if (event.target === modal) {
            modal.style.display = "none";
        }
    }
    document.addEventListener('DOMContentLoaded', function () {

        document.querySelectorAll('.add-to-wishlist-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const productId = this.closest('.product-btns').dataset.productId;
                const icon = this.querySelector('i');
                const tooltip = this.querySelector('.tooltipp');

                fetch(`/wishlist/add/${productId}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest'}
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector('#wishlist-qty').textContent = data.wishlist_qty;
                            showNotification(
                                data.action === 'added' ? "Товар добавлен в избранное!" : "Товар удалён из избранного!",
                                data.action === 'added' ? "success" : "error"
                            );

                            // Изменяем стиль кнопки и иконку
                            if (data.action === 'added') {
                                btn.classList.add('in-wishlist');
                                icon.classList.remove('fa-heart-o');
                                icon.classList.add('fa-heart');
                                tooltip.textContent = "В избранном";
                            } else {
                                btn.classList.remove('in-wishlist');
                                icon.classList.remove('fa-heart');
                                icon.classList.add('fa-heart-o');
                                tooltip.textContent = "Добавить в избранное";
                            }

                        } else {
                            showNotification(data.error || "Ошибка!", "error");
                        }
                    });
            });
        });

        // Добавить в корзину
        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const productId = this.closest('.product-btns').dataset.productId;
                fetch(`/cart/add/${productId}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest'}
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector('#cart-qty').textContent = data.cart_qty;
                            showNotification("Товар добавлен в корзину!");
                        } else {
                            showNotification(data.error || "Ошибка!", "error");
                        }
                    });
            });
        });

        // Быстрый просмотр
        document.querySelectorAll('.quick-view-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const productId = this.closest('.product-btns').dataset.productId;

                fetch(`/product/quick-view/${productId}/`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('product-name').textContent = data.name;
                        document.getElementById('product-description').textContent = data.description;
                        document.getElementById('product-category').textContent = data.category;
                        document.getElementById('product-price').textContent = data.price + " сом";
                        document.getElementById('product-old-price').textContent = data.old_price ? data.old_price + " сом" : "";
                        document.getElementById('product-image').src = data.image;

                        // открываем модалку
                        document.getElementById('product-modal').style.display = "block";
                    });
            });
        });

        // Удаление (делегирование)
        document.addEventListener('click', function (e) {
            // Удалить из корзины
            const cartBtn = e.target.closest('.remove-cart-item');
            if (cartBtn) {
                const productId = cartBtn.dataset.productId;
                fetch(`/cart/remove/${productId}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                })
                    .then(res => res.text())
                    .then(html => {
                        document.querySelector('#cart-items').innerHTML = html;
                        document.querySelector('#cart-qty').textContent = document.querySelectorAll('#cart-items .product-widget').length;
                    });
            }

            // Удалить из избранного
            const wishlistBtn = e.target.closest('.remove-wishlist-item');
            if (wishlistBtn) {
                const productId = wishlistBtn.closest('.product-widget').dataset.productId;
                fetch(`/wishlist/remove/${productId}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                })
                    .then(res => res.text())
                    .then(html => {
                        document.querySelector('#wishlist-items').innerHTML = html;
                        document.querySelector('#wishlist-qty').textContent = document.querySelectorAll('#wishlist-items .product-widget').length;
                    });
            }
        });

        // Поиск с подсказками
        const searchInput = document.getElementById('search-input');
        const suggestionsBox = document.getElementById('search-suggestions');
        const categorySelect = document.getElementById('search-category');
        let timeout = null;

        if (searchInput) {
            searchInput.addEventListener('input', function () {
                clearTimeout(timeout);
                const query = this.value.trim();
                const category = categorySelect.value;

                if (!query) {
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                    return;
                }

                timeout = setTimeout(() => {
                    fetch(`/search-suggestions/?q=${encodeURIComponent(query)}&category=${category}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.suggestions.length > 0) {
                                suggestionsBox.innerHTML = data.suggestions.map(item => `<div class="suggestion-item">${item}</div>`).join('');
                            } else {
                                suggestionsBox.innerHTML = '<div class="suggestion-item">Ничего не найдено</div>';
                            }
                            suggestionsBox.style.display = 'block';

                            document.querySelectorAll('.suggestion-item').forEach(el => {
                                el.addEventListener('click', () => {
                                    searchInput.value = el.textContent;
                                    document.getElementById('search-form').submit();
                                });
                            });
                        });
                }, 300);
            });

            // Скрыть подсказки при клике вне
            document.addEventListener('click', e => {
                if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                    suggestionsBox.style.display = 'none';
                }
            });
        }

        const clearBtn = document.getElementById('clear-search');
        if (clearBtn && searchInput) {
            searchInput.addEventListener('input', () => {
                clearBtn.style.display = searchInput.value ? 'block' : 'none';
            });
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearBtn.style.display = 'none';
                searchInput.focus();
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            });
        }
    });
</script>
<div id="product-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeProductModal()">&times;</span>
        <h2 id="product-name"></h2>
        <div class="image-carousel">
            <img id="product-image" src="" alt="">
        </div>
        <table id="product-info">
            <tr>
                <td>Описание:</td>
                <td id="product-description"></td>
            </tr>
            <tr>
                <td>Категория:</td>
                <td id="product-category"></td>
            </tr>
            <tr>
                <td>Цена:</td>
                <td id="product-price"></td>
            </tr>
            <tr>
                <td>Старая цена:</td>
                <td id="product-old-price"></td>
            </tr>
        </table>
    </div>
</div>