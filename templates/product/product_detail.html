{% load static %}
{% load filters %}
{% include 'base.html' %}
{% include 'partials/navbar.html' %}

<div id="breadcrumb" class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h3 class="breadcrumb-header">{{ product.name }}</h3>
                <ul class="breadcrumb-tree">
                    <li><a href="{% url 'home' %}">Главная</a></li>
                    <li class="active">информация</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-2">
                <div id="thumbs" class="d-flex flex-column align-items-center">
                    {# Сначала обложка #}
                    {% if product.image %}
                        <img src="{{ product.image.url }}"
                             class="img-thumbnail mb-2 thumb active"
                             data-target="#mainImage"
                             data-img="{{ product.image.url }}"
                             alt="{{ product.name }}">
                    {% endif %}

                    {# Затем остальные фото из связанных изображений #}
                    {% for image in product.images.all %}
                        <img src="{{ image.image.url }}"
                             class="img-thumbnail mb-2 thumb {% if not product.image and forloop.first %}active{% endif %}"
                             data-target="#mainImage"
                             data-img="{{ image.image.url }}"
                             alt="{{ product.name }}">
                    {% empty %}
                        {% if not product.image %}
                            <img src="{% static 'img/no-image.png' %}"
                                 class="img-thumbnail mb-2 active"
                                 data-target="#mainImage"
                                 data-img="{% static 'img/no-image.png' %}"
                                 alt="Нет фото">
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="col-md-5">
                <div class="main-image text-center">
                    {% if product.image %}
                        <img id="mainImage" src="{{ product.image.url }}" class="img-fluid" alt="{{ product.name }}">
                    {% elif product.images.first %}
                        <img id="mainImage" src="{{ product.images.first.image.url }}" class="img-fluid"
                             alt="{{ product.name }}">
                    {% else %}
                        <img id="mainImage" src="{% static 'img/no-image.png' %}" class="img-fluid" alt="Нет фото">
                    {% endif %}
                </div>
            </div>


            <div class="col-md-5">
                <div class="product-details">
                    <h2 class="product-name">{{ product.name }}</h2>
                    <h3 class="product-price">
                        {{ product.price|humanize_price }} ₽
                        {% if product.old_price %}
                            <del class="product-old-price">${{ product.old_price|humanize_price }}</del>
                        {% endif %}
                    </h3>

                    {% if product.is_new %}
                        <span class="text-success">В наличии</span>
                    {% else %}
                        <span class="text-danger">Нет в наличии</span>
                    {% endif %}

                    <br>
                    <strong>Категория:</strong> {{ product.category.name }}<br>
                    <strong>Бренд:</strong>
                    {% if product.brand %}
                        {{ product.brand.name }}
                    {% else %}
                        не указан
                    {% endif %}
                    <br>

                    <div class="add-to-cart" data-product-id="{{ product.id }}" style="margin-top: 20px">
                        <div class="qty-label">
                            Кол-во
                            <div class="input-number">
                                <input type="number" class="cart-qty" value="1" min="1">
                                <span class="qty-up">+</span>
                                <span class="qty-down">-</span>
                            </div>
                        </div>
                        {% if user.is_authenticated %}
                            <button class="add-to-cart-btn btn btn-danger mt-3">
                                <i class="fa fa-shopping-cart"></i> В корзину
                            </button>
                        {% else %}
                            <button class="add-to-cart-btn btn mt-3 disabled-btn" disabled
                                    title="Только для авторизованных пользователей">
                                <i class="fa fa-shopping-cart"></i> В корзину
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-12">
            <div id="product-tab">
                <ul class="tab-nav">
                    <li class="active"><a data-toggle="tab" href="#tab1">Описание</a></li>
                    <li><a data-toggle="tab" href="#tab2">Детали</a></li>
                </ul>

                <div class="tab-content">
                    <div id="tab1" class="tab-pane fade in active">
                        <div class="row">
                            <div class="col-md-12">
                                <p>{{ product.description }}</p>
                            </div>
                        </div>
                    </div>
                    <div id="tab2" class="tab-pane fade in">
                        <div class="row">
                            <div class="col-md-12">
                                <!-- Бренд -->
                                {% if product.brand %}
                                    <p><strong>Бренд:</strong> {{ product.brand.name }}</p>
                                {% endif %}

                                <!-- Цена и статус -->
                                <p>
                                    <strong>Цена:</strong>
                                    {% if product.old_price %}
                                        <span class="text-muted" style="text-decoration: line-through;">
                    {{ product.old_price|humanize_price }} ₽
                </span>
                                    {% endif %}
                                    <span class="text-danger fw-bold">{{ product.price|humanize_price }} ₽</span>

                                    {% if product.discount %}
                                        <span class="badge bg-success">-{{ product.discount }}%</span>
                                    {% endif %}

                                    {% if product.status %}
                                        {% if product.status == 'new' %}
                                            <span class="status-badge status-new">Новый</span>
                                        {% elif product.status == 'excellent' %}
                                            <span class="status-badge status-excellent">Отличное состояние</span>
                                        {% elif product.status == 'defect' %}
                                            <span class="status-badge status-defect">Есть дефекты</span>
                                        {% elif product.status == 'marriage' %}
                                            <span class="status-badge status-marriage">На запчасти</span>
                                        {% endif %}
                                    {% endif %}
                                </p>

                                <!-- Наличие -->
                                <p>
                                    <strong>Наличие:</strong>
                                    {% if product.is_available %}
                                        <span class="text-success">В наличии</span>
                                    {% else %}
                                        <span class="text-danger">Нет в наличии</span>
                                    {% endif %}
                                </p>

                                <!-- Комплектация -->
                                {% if product.complectation %}
                                    <h5 class="mt-3">Комплектация:</h5>
                                    <p>{{ product.complectation|linebreaks }}</p>
                                {% endif %}

                                <!-- Даты -->
                                <small class="text-muted">
                                    Добавлен: {{ product.created_at|date:"d.m.Y" }},
                                    обновлён: {{ product.updated_at|date:"d.m.Y" }}
                                </small>

                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="section">
    <!-- container -->
    <div class="container">
        <!-- row -->
        <div class="row">

            <div class="col-md-12">
                <div class="section-title text-center">
                    <h3 class="title">Похожие товары</h3>
                </div>
            </div>

            <div class="row">
                {% for p in related_products %}
                    <div class="col-md-3 col-xs-6">
                        <div class="product">
                            <div class="product-img">
                                <img src="{{ p.image.url|default:'/static/img/product01.png' }}" alt="{{ p.name }}">
                                {% if p.discount %}
                                    <div class="product-label">
                                        <span class="sale">-{{ p.discount }}%</span>
                                    </div>
                                {% endif %}
                                {% if p.is_new %}
                                    <div class="product-label">
                                        <span class="new">Новинка</span>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="product-body">
                                <p class="product-category">{{ p.category.name }}</p>
                                <h3 class="product-name">
                                    <a href="{{ p.get_absolute_url }}">{{ p.name }}</a>
                                </h3>
                                <h4 class="product-price">
                                    {{ p.price|humanize_price }} ₽
                                    {% if p.old_price %}
                                        <del class="product-old-price">{{ p.old_price|humanize_price }} ₽</del>
                                    {% endif %}
                                </h4>
                                <div class="product-btns" data-product-id="{{ p.id }}">
                                    {% if user.is_authenticated %}
                                        <button class="add-to-wishlist-btn">
                                            <i class="fa fa-heart-o"></i>
                                            <span class="tooltipp">Добавить в избранное</span>
                                        </button>
                                        <button class="add-to-cart-btn">
                                            <i class="fa fa-shopping-cart"></i>
                                            <span class="tooltipp">Добавить в корзину</span>
                                        </button>
                                    {% else %}
                                        <button class="add-to-wishlist-btn disabled-btn" disabled
                                                title="Только для авторизованных пользователей">
                                            <i class="fa fa-heart-o"></i>
                                            <span class="tooltipp">Только для авторизованных пользователей</span>
                                        </button>
                                        <button class="add-to-cart-btn disabled-btn" disabled
                                                title="Только для авторизованных пользователей">
                                            <i class="fa fa-shopping-cart"></i>
                                            <span class="tooltipp">Только для авторизованных пользователей</span>
                                        </button>
                                    {% endif %}
                                    <button class="quick-view-btn">
                                        <i class="fa fa-eye"></i>
                                        <span class="tooltipp">Быстрый просмотр</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-center">Нет похожих товаров</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.querySelectorAll('.add-to-cart').forEach(block => {
        const btn = block.querySelector('.add-to-cart-btn');
        const qtyInput = block.querySelector('.cart-qty');
        const productId = block.dataset.productId;

        block.querySelector('.qty-up').addEventListener('click', () => {
            qtyInput.value = parseInt(qtyInput.value) + 1;
        });

        block.querySelector('.qty-down').addEventListener('click', () => {
            if (parseInt(qtyInput.value) > 1) {
                qtyInput.value = parseInt(qtyInput.value) - 1;
            }
        });

        btn.addEventListener('click', () => {
            const qty = qtyInput.value;

            fetch(`/cart/add/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({quantity: qty})
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector('#cart-qty').textContent = data.cart_qty;
                        showNotification("Товар добавлен в корзину!");
                    } else {
                        showNotification("Ошибка при добавлении!", "error");
                    }
                });
        });
    });
</script>
<script>
    document.querySelectorAll('.thumb').forEach(thumb => {
        thumb.addEventListener('click', function () {
            document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('mainImage').src = this.dataset.img;
        });
    });
</script>
{% include 'partials/footer.html' %}